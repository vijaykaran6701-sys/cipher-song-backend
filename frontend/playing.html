<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Now Playing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, sans-serif;
      color: white;
    }
  </style>
</head>

<body>

  <!-- Global Nav -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-black/80 backdrop-blur-md text-white">
    <div class="max-w-6xl mx-auto flex items-center justify-between p-3">
      <a href="index.html" class="flex items-center gap-2">
        <img src="images/cipher_logo.png" alt="Cipher Song Logo" class="h-6 w-6 object-contain"/>
        <span class="font-semibold">Cipher Song</span>
      </a>
      <nav class="flex gap-3 text-sm">
        <a href="index.html" class="hover:underline">Home</a>
        <a href="library.html" class="hover:underline">Library</a>
        <a href="playlist.html" class="hover:underline">Playlists</a>
        <a href="artist.html" class="hover:underline">Artists</a>
        <a href="upload.html" class="hover:underline">Upload</a>
        <a href="auth.html" class="hover:underline">Login</a>
        <a href="signup.html" class="hover:underline">Signup</a>
      </nav>
    </div>
  </header>

  <!-- Player -->
  <div class="w-[340px] bg-white/5 backdrop-blur-xl rounded-3xl p-5 shadow-2xl border border-white/10 mt-16">

    <!-- Cover -->
    <img
      id="cover"
      class="w-full h-72 object-cover rounded-2xl mb-4 shadow-lg transition hover:scale-[1.02]"
      src=""
      alt="cover"
    />

    <!-- Info -->
    <h2 id="title" class="text-xl font-bold truncate">Loading...</h2>
    <p id="artist" class="text-sm text-zinc-400 mb-4">Please wait</p>

    <!-- Controls -->
    <div class="flex items-center gap-3">
      <button
        id="playBtn"
        class="w-14 h-14 rounded-full bg-green-500 text-black text-xl font-bold flex items-center justify-center hover:scale-105 transition"
      >
        ▶
      </button>

      <input
        id="progress"
        type="range"
        value="0"
        class="flex-1 accent-green-500"
      />
    </div>

    <audio id="audio"></audio>
  </div>

  <!-- SCRIPT -->
  <script>
    const audio = document.getElementById("audio");
    const playBtn = document.getElementById("playBtn");
    const progress = document.getElementById("progress");

    // disable play until a playable song is loaded
    playBtn.disabled = true;
    playBtn.classList.add("opacity-50");

    // API base (update to your deployed backend)
    const API = "https://cipher-song-2.onrender.com";

    async function loadSong() {
      try {
        const res = await fetch(`${API}/api/songs`);
        if (!res.ok) {
          console.error('Songs API error', res.status);
          return;
        }
        const songs = await res.json();
        const song = songs[0];

        document.getElementById("title").innerText = song.title;
        document.getElementById("artist").innerText =
          song.artist?.name || "Unknown Artist";

        document.getElementById("cover").src =
          song.cover ? `${API}${song.cover}` : "images/placeholder.svg";

        if (song.audio) {
          audio.src = `${API}${song.audio}`;
          playBtn.disabled = false;
          playBtn.classList.remove("opacity-50");
          playBtn.innerText = "⏸";
        } else {
          audio.src = "";
          playBtn.disabled = true;
          playBtn.classList.add("opacity-50");
          playBtn.innerText = "—";
        }

        // tell backend we played the song
        fetch(`${API}/api/songs/${song._id}/play`, { method: "PUT" }).catch(err => console.error("Play count update failed:", err));
      } catch(err) {
        console.error('Failed to load song:', err);
      }
    }

    playBtn.onclick = () => {
      if (playBtn.disabled) return;
      if (audio.paused) {
        audio.play().catch(err => console.error("Playback failed:", err));
        playBtn.innerText = "⏸";
      } else {
        audio.pause();
        playBtn.innerText = "▶";
      }
    };

    audio.ontimeupdate = () => {
      progress.value = (audio.currentTime / audio.duration) * 100 || 0;
    };

    progress.oninput = () => {
      audio.currentTime = (progress.value / 100) * audio.duration;
    };

    loadSong();
    // play count update is handled after the song loads inside loadSong()

  </script>

</body>
</html>
